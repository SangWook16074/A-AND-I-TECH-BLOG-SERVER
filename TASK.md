# TASK.md

## 작업 운영 원칙
- 본 문서는 `PLAN.md`를 실행하기 위한 작업 지시서다.
- 모든 기능은 **TDD 원칙(실패 테스트 -> 최소 구현 -> 리팩터링)** 으로 진행한다.
- 한 번에 한 단계만 진행하며, 단계 시작 전 반드시 사용자 승인을 받는다.
- 승인 없이 코드 변경/의존성 추가/설정 변경/테스트 실행을 진행하지 않는다.

## TDD 실행 규칙 (모든 단계 공통)
1. Red
- 해당 단계의 요구사항을 검증하는 테스트를 먼저 작성한다.
- 테스트는 현재 코드에서 실패해야 한다.

2. Green
- 테스트를 통과시키는 최소 구현만 추가한다.
- 과도한 추상화/선구현 금지.

3. Refactor
- 테스트 통과 상태를 유지하면서 구조/이름/중복 개선.
- 리팩터링 후 전체 관련 테스트 재실행.

4. 보고
- 단계 종료 시 아래 항목을 사용자에게 보고한다.
  - 추가/수정 파일 목록
  - 작성한 테스트 목록
  - 통과/실패 테스트 결과 요약
  - 다음 단계 제안 및 승인 요청

## 단계별 실행 태스크 (PLAN.md 기반)

## STEP 1 (P0): 프로젝트 기반 설정
목표:
- WebFlux + R2DBC + OpenAPI + S3 + 테스트 인프라 기반을 구축한다.

TDD 작업:
- [ ] (Red) 애플리케이션 컨텍스트 기동/필수 빈 로딩 테스트 추가
- [ ] (Red) 테스트 프로필에서 DB(Testcontainers) 연결 검증 테스트 추가
- [ ] (Green) `build.gradle.kts` 의존성/플러그인 반영
- [ ] (Green) `application*.yaml` 프로필/설정 분리
- [ ] (Refactor) 설정 키 정리 및 공통 prefix 통일

완료 기준:
- 로컬/테스트 프로필에서 기동 성공
- 기반 테스트 통과

## STEP 2 (P0): Post 도메인/DB
목표:
- `Post` 모델, 상태 enum, 마이그레이션, 리포지토리를 구축한다.

TDD 작업:
- [ ] (Red) 도메인 검증 테스트(제목 길이, 필수값) 작성
- [ ] (Red) 리포지토리 CRUD 테스트 작성
- [ ] (Green) 도메인/리포지토리/마이그레이션 구현
- [ ] (Refactor) 쿼리/인덱스/매핑 구조 정리

완료 기준:
- 스키마와 PRD 일치
- 리포지토리 테스트 통과

## STEP 3 (P0): 게시글 API 5종
목표:
- 게시글 CRUD + 목록 페이징 API를 구현한다.

TDD 작업:
- [ ] (Red) WebTestClient로 각 엔드포인트 계약 테스트 작성
- [ ] (Red) 예외 시나리오 테스트(404, validation) 작성
- [ ] (Green) 컨트롤러/서비스/DTO/매퍼 구현
- [ ] (Green) 상태코드/응답 스키마 일치화
- [ ] (Refactor) 공통 응답/변환 로직 정리

완료 기준:
- `POST/GET(one)/GET(list)/PATCH/DELETE` 전부 테스트 통과

## STEP 4 (P0): 이미지 업로드 API
목표:
- 멀티파트 이미지 업로드 및 S3 URL 반환을 구현한다.

TDD 작업:
- [ ] (Red) 허용 타입/크기 제한 테스트 작성
- [ ] (Red) 업로드 성공/실패 테스트 작성
- [ ] (Green) S3 async 업로드 서비스 및 API 구현
- [ ] (Refactor) 파일 정책/키 생성 전략 분리

완료 기준:
- 업로드 성공 시 `url/key/contentType/size` 반환
- 정책 위반 시 표준 에러 반환

## STEP 5 (P1): 인증/인가 최소 적용
목표:
- 익명 Read-only, 인증 사용자 CRUD 정책 적용.

TDD 작업:
- [ ] (Red) 권한별 접근 테스트 작성
- [ ] (Green) 임시 인증 필터/권한 규칙 구현
- [ ] (Refactor) 추후 JWT/OAuth2 교체 가능한 인터페이스화

완료 기준:
- 권한 분기 테스트 통과

## STEP 6 (P1): 공통 예외/로깅/추적
목표:
- 전역 예외 포맷과 Correlation ID 기반 추적을 적용한다.

TDD 작업:
- [ ] (Red) 에러 응답 포맷 테스트 작성
- [ ] (Red) traceId 전파 테스트 작성
- [ ] (Green) 전역 예외 처리기/필터 구현
- [ ] (Refactor) 에러 코드 체계/로그 메시지 정리

완료 기준:
- 오류 응답 일관성 확보
- 로그 추적 가능

## STEP 7 (P1): OpenAPI 문서화
목표:
- API 스펙 자동 문서화를 완성한다.

TDD 작업:
- [ ] (Red) OpenAPI 문서 노출 테스트 작성
- [ ] (Green) springdoc 설정 및 스키마 주석 반영
- [ ] (Refactor) 문서 설명/예시 정리

완료 기준:
- PRD API가 Swagger/OpenAPI에 반영

## STEP 8 (P0): 테스트 품질 보강
목표:
- 단위/웹/통합 테스트를 보강하고 커버리지 80% 이상 달성.

TDD 작업:
- [ ] (Red) 누락 시나리오(경계값/예외) 테스트 추가
- [ ] (Green) 누락 구현 보완
- [ ] (Refactor) 테스트 픽스처/헬퍼 정리
- [ ] 커버리지 리포트 확인 및 부족 영역 보강

완료 기준:
- 전체 테스트 green
- 커버리지 80% 이상

## STEP 9 (P2): 성능/배포 준비
목표:
- 운영 투입 전 성능/배포 최소 조건을 갖춘다.

TDD 작업:
- [ ] (Red) 핵심 API 성능 회귀 감지용 테스트/지표 기준 수립
- [ ] (Green) 성능 병목 개선(인덱스/쿼리/타임아웃)
- [ ] (Green) Dockerfile/실행 문서 정리
- [ ] (Refactor) 운영 설정 정리

완료 기준:
- 배포/운영에 필요한 기본 산출물 확보

## 승인 게이트
- [ ] Gate A: STEP 1 시작 승인
- [ ] Gate B: STEP 2 시작 승인
- [ ] Gate C: STEP 3 시작 승인
- [ ] Gate D: STEP 4 시작 승인
- [ ] Gate E: STEP 5 시작 승인
- [ ] Gate F: STEP 6 시작 승인
- [ ] Gate G: STEP 7 시작 승인
- [ ] Gate H: STEP 8 시작 승인
- [ ] Gate I: STEP 9 시작 승인

## 작업 요청 템플릿 (매 단계 시작 전)
아래 형식으로 승인 요청 후 진행한다.

```
[승인 요청]
진행 단계: STEP N
목표: ...
변경 예정 파일: ...
먼저 작성할 실패 테스트: ...
예상 완료 기준: ...
승인 여부: (예/아니오)
```
